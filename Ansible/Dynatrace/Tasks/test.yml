---
  - name: Download OneAgent installer using PowerShell
    win_shell: |
      [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12;
      Invoke-WebRequest -Uri '{{ dynatrace_environment_url }}/api/v1/deployment/installer/agent/windows/default/latest?arch=x86' -Headers @{ 'Authorization' = 'Api-Token {{ dynatrace_api_token }}' } -OutFile '{{ oneagent_installer_path }}'

  - name: Install OneAgent
    win_shell: "{{ oneagent_installer_path }} --set-monitoring-mode=fullstack --set-app-log-content-access=true /quiet /norestart"
    args:
      creates: "{{ oneagent_expected_path }}"

  - name: Validate OneAgent installation
    win_stat:
      path: "{{ oneagent_expected_path }}"
    register: oneagent_installation

  - name: Check if OneAgent installation is successful
    assert:
      that:
        - oneagent_installation.stat.exists
      fail_msg: "OneAgent installation failed. The installer did not create the expected file."

  - name: Check OneAgent service status
    win_shell: "sc query '{{ oneagent_service_name }}' | findstr /i 'RUNNING'"
    register: oneagent_service_status
    failed_when: "'RUNNING' not in oneagent_service_status.stdout"

  - name: Ensure OneAgent service is running
    assert:
      that:
        - "'RUNNING' in oneagent_service_status.stdout"
      fail_msg: "OneAgent service is not running."